# # 1) Base image
# FROM python:3.12.7-slim AS runtime

# # 2) Environment
# ENV PYTHONDONTWRITEBYTECODE=1 \
#     PYTHONUNBUFFERED=1 \
#     PIP_NO_CACHE_DIR=1

# # 3) OS packages
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     build-essential \
#     libpq-dev \
#     curl \
#     netcat-openbsd \
#   && rm -rf /var/lib/apt/lists/*


# # 4) Create non-root user
# RUN useradd -m appuser

# # 5) Workdir
# WORKDIR /app

# # 6) Dependencies (cached when requirements.txt unchanged)
# COPY requirements.txt /app/requirements.txt
# RUN pip install --upgrade pip && pip install -r requirements.txt

# # 7) App source
# COPY . /app

# # 8) Entrypoint: copy, chmod, and set ownership
# COPY entrypoint.sh /entrypoint.sh
# RUN chmod +x /entrypoint.sh \
#     && chown appuser:appuser /entrypoint.sh \
#     && chown -R appuser:appuser /app

# # 9) Drop privileges
# USER appuser

# # 10) Networking
# EXPOSE 8000

# # 11) Start-up
# ENTRYPOINT ["/entrypoint.sh"]
# # CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
# CMD ["gunicorn", "--bind", "0.0.0.0:8000", "config.wsgi:application"]




# 1) Base image
FROM python:3.12.7-slim AS runtime

# 2) Environment
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

# 3) OS packages
#    — original: build-essential, libpq-dev, curl, netcat-openbsd
#    — added:  libmagic1      (file-type detection for resume uploads)
#              poppler-utils  (PDF metadata, used by pdfplumber internally)
#              libgl1          (required by PyMuPDF / fitz)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    netcat-openbsd \
    libmagic1 \
    poppler-utils \
    libgl1 \
  && rm -rf /var/lib/apt/lists/*

# 4) Create non-root user
RUN useradd -m appuser

# 5) Workdir
WORKDIR /app

# 6) Dependencies (cached when requirements.txt unchanged)
COPY requirements.txt /app/requirements.txt
RUN pip install --upgrade pip && pip install -r requirements.txt

# 7) Pre-download sentence-transformers model at build time
#    so workers don't download it on first task run
RUN python -c "\
from sentence_transformers import SentenceTransformer; \
SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"

# 8) App source
COPY . /app

# 9) Create required directories for vector store, media and static
#    (also created via docker volume, but needs to exist inside image)
RUN mkdir -p /app/chroma_db /app/media /app/static

# 9) Entrypoint: copy, chmod, and set ownership
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh \
    && chown appuser:appuser /entrypoint.sh \
    && chown -R appuser:appuser /app

# 10) Drop privileges
USER appuser

# 11) Networking
EXPOSE 8000

# 12) Start-up
ENTRYPOINT ["/entrypoint.sh"]
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "config.wsgi:application"]